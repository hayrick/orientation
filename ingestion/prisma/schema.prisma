
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model School {
  uai       String           @id
  name      String
  status    String // Public, Privé
  locations SchoolLocation[]
  formations Formation[]
  panierStats PanierSchoolStats[]
}

model SchoolLocation {
  id             String      @id // Composite: uai-city (sanitized)
  schoolUai      String
  city           String
  departmentCode String
  departmentName String
  region         String
  academy        String
  latitude       Float?
  longitude      Float?
  
  school         School      @relation(fields: [schoolUai], references: [uai])
  formations     Formation[]
}

model Formation {
  id              String         @id // "Session" cod
  locationId      String
  name            String
  filiereFormationDetaillee String?
  filiereFormationDetailleeBis String?
  filiereTresDetaillee String?
  parcoursupLink  String?
  category        String
  selectivity     String
  capacity        Int
  totalCandidates Int?
  totalCandidatesWithAdmissionProposal Int?
  
  admissionRate   Float
  lastCalledRank  Int?
  genderParity    Float? // % women
  
  mentionDistribution String?

  location        SchoolLocation @relation(fields: [locationId], references: [id])
  
  schoolUai       String
  school          School         @relation(fields: [schoolUai], references: [uai])
}

model MasterFormation {
  id      String   @id
  name    String   @unique
  paniers PanierMasterFormation[]
}

model Panier {
  id               String            @id
  name             String
  cpgeType         String
  url              String?
  masterFormations PanierMasterFormation[]
  schoolStats      PanierSchoolStats[]
}

model PanierMasterFormation {
  panierId          String
  masterFormationId String
  panier            Panier          @relation(fields: [panierId], references: [id])
  masterFormation   MasterFormation @relation(fields: [masterFormationId], references: [id])

  @@id([panierId, masterFormationId])
}

model PanierSchoolStats {
  id                 String  @id
  panierId           String
  schoolUai          String
  tauxIntegrationPct Float?
  moyenneBac         Float?
  moyenneMultiAnsPct Float?
  rangMultiAns       String?
  parcoursup         Boolean?

  panier             Panier @relation(fields: [panierId], references: [id])
  school             School @relation(fields: [schoolUai], references: [uai])
}

model CpgeMapping {
  id                Int     @id @default(autoincrement())
  etudiantType      String  // e.g. "PSI", "ECG - Mathématiques appliquées + HGG"
  parcoursupFiliere String // e.g. "PCSI", "ECG - Mathématiques appliquées + ESH"
  schoolUai         String? // NULL for Type 1 (Global), contains UAI for Type 2 (Override)
  
  @@unique([etudiantType, schoolUai])
}

// ============================================
// Specialty Admission Data Tables
// ============================================

// Reference table of high school specialties
model Specialty {
  id        String @id  // e.g., 'maths', 'physique-chimie', 'ses'
  name      String      // Full name: "Mathématiques Spécialité"
  shortName String?     // Short name: "Maths"
  
  stats1    SpecialtyAdmissionStats[] @relation("Specialty1")
  stats2    SpecialtyAdmissionStats[] @relation("Specialty2")
}

// Maps simplified CPGE categories (from CSV) to our detailed cpgeTypes
model CpgeCategoryMapping {
  id          Int    @id @default(autoincrement())
  csvCategory String // 'CPGE ECG', 'CPGE L', 'CPGE S'
  cpgeType    String // Our detailed cpgeType e.g. 'ECG - Mathématiques appliquées + ESH'
  
  @@unique([csvCategory, cpgeType])
}

// Admission statistics by specialty combination
model SpecialtyAdmissionStats {
  id               String @id  // e.g., 'maths-ses-cpge-ecg'
  specialty1Id     String
  specialty2Id     String
  cpgeCategory     String      // 'CPGE ECG', 'CPGE L', 'CPGE S'
  candidats        Int         // Total candidates with this combo
  propositions     Float       // Candidates who received an offer
  acceptes         Int         // Candidates who accepted
  admissionRatePct Float?      // propositions / candidats * 100
  
  specialty1       Specialty @relation("Specialty1", fields: [specialty1Id], references: [id])
  specialty2       Specialty @relation("Specialty2", fields: [specialty2Id], references: [id])
}

